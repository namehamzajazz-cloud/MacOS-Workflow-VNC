name: mac
on:
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360
    steps:
    - uses: actions/checkout@v3

    - name: ğŸ§° Install and Authenticate Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        brew install --quiet tailscale
        sudo tailscaled --cleanup || true
        sudo tailscaled > /tmp/tailscaled.log 2>&1 &
        sleep 5
        sudo tailscale up --authkey "$TAILSCALE_AUTH_KEY" --hostname "GitHub-MacOS" --ssh
        echo "âœ… Tailscale connected!"
        tailscale ip -4

    - name: ğŸ Enable macOS Screen Sharing (VNC)
      env:
        VNC_PASS: ${{ secrets.VNC_PASS }}
      run: |
        # Enable remote management
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all

        # Set VNC password (encrypted)
        echo "$VNC_PASS" | perl -we 'use Digest::MD5 qw(md5); use MIME::Base64; my $pw=<>; chomp($pw); print encode_base64(md5($pw));' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt >/dev/null
        
        echo "âœ… Screen Sharing (VNC) enabled."

    - name: ğŸŒ Show Connection Info
      run: |
        echo "---------------------------------------------"
        echo "ğŸ–¥ï¸  Connect to your macOS VM via Remote Desktop"
        echo "---------------------------------------------"
        echo "ğŸ’» Get the Tailscale IP from your Tailscale app"
        echo "ğŸ”‘ Password: (your VNC_PASS secret)"
        echo "ğŸ‘¤ User: runner"
        echo "---------------------------------------------"
        echo "ğŸ’¡ Tip: Use Microsoft Remote Desktop or any VNC client."
        echo "ğŸ’¡ Your machine should appear as 'GitHub-MacOS' in Tailscale!"

    - name: ğŸ§‘â€ğŸ’» Optional Debug Session (tmate)
      uses: mxschmitt/action-tmate@v3
      if: always()        NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "---------------------------------------------"
        echo "ğŸ–¥ï¸  Connect to macOS desktop with VNC (any app):"
        echo "ğŸ‘‰ Address: ${NGROK_URL#tcp://}"
        echo "ğŸ”‘ Password: (your VNC_PASS secret)"
        echo "---------------------------------------------"
        echo "ğŸ’¡ Tip: Use 'Microsoft Remote Desktop' or 'VNC Viewer' to connect!"

    - name: ğŸ§‘â€ğŸ’» Optional Debug (tmate)
      uses: mxschmitt/action-tmate@v3
      if: always()
