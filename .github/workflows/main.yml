name: mac
on: 
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360
    steps:
    - uses: actions/checkout@v3

    - name: ğŸ Setup macOS Screen Sharing (VNC)
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        VNC_PASS: ${{ secrets.VNC_PASS }}
      run: |
        # Enable Screen Sharing (VNC)
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all
        
        # Set VNC password
        echo "$VNC_PASS" | perl -we 'use Digest::MD5 qw(md5); use MIME::Base64; my $pw=<>; chomp($pw); print encode_base64(md5($pw));' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt >/dev/null
        
        # Start ngrok TCP tunnel on VNC port (5900)
        brew install --quiet ngrok jq
        ngrok authtoken "$NGROK_AUTH_TOKEN"
        ngrok tcp 5900 --region=us > ngrok.log &
        sleep 8

    - name: ğŸŒ Show VNC Connection Info
      run: |
        echo "---------------------------------------------"
        echo "ğŸ” Fetching ngrok TCP tunnel info..."
        NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "---------------------------------------------"
        echo "ğŸ–¥ï¸  Connect to macOS desktop with VNC (any app):"
        echo "ğŸ‘‰ Address: ${NGROK_URL#tcp://}"
        echo "ğŸ”‘ Password: (your VNC_PASS secret)"
        echo "---------------------------------------------"
        echo "ğŸ’¡ Tip: Use 'Microsoft Remote Desktop' or 'VNC Viewer' to connect!"

    - name: ğŸ§‘â€ğŸ’» Optional Debug (tmate)
      uses: mxschmitt/action-tmate@v3
      if: always()
