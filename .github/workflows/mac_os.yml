name: mac
on:
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360
    steps:
    - uses: actions/checkout@v3

    - name: ğŸ§° Install and Start Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "ğŸš€ Installing Tailscale..."
        brew install --quiet tailscale
        sudo tailscaled --cleanup || true
        sudo tailscaled > /tmp/tailscaled.log 2>&1 &
        sleep 5
        sudo tailscale up --authkey "$TAILSCALE_AUTH_KEY" --hostname "GitHub-MacOS" --ssh
        echo "âœ… Tailscale connected!"
        tailscale ip -4

    - name: ğŸ Enable Full macOS GUI (Finder, Dock, etc.)
      run: |
        echo "ğŸ§  Starting macOS GUI processes..."
        open -a Finder
        open -a Dock
        open -a SystemUIServer
        echo "âœ… GUI environment initialized."

    - name: ğŸ Enable Screen Sharing (VNC)
      env:
        VNC_PASS: ${{ secrets.VNC_PASS }}
      run: |
        echo "ğŸ”§ Enabling Screen Sharing..."
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all

        echo "$VNC_PASS" | perl -we 'use Digest::MD5 qw(md5); use MIME::Base64; my $pw=<>; chomp($pw); print encode_base64(md5($pw));' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt >/dev/null

        echo "âœ… VNC password set and service activated."

    - name: ğŸŒ Show Connection Info
      run: |
        echo "---------------------------------------------"
        echo "ğŸ–¥ï¸  macOS Remote Desktop via Tailscale"
        echo "---------------------------------------------"
        echo "ğŸ’» Open your Tailscale app and find 'GitHub-MacOS'"
        echo "ğŸ“¡ Use its IP (100.x.x.x) to connect in Remote Desktop"
        echo "ğŸ‘¤ Username: runner"
        echo "ğŸ”‘ Password: (your VNC_PASS secret)"
        echo "---------------------------------------------"
        echo "ğŸ’¡ You can connect using:"
        echo "   - Microsoft Remote Desktop (Mac/Windows)"
        echo "   - VNC Viewer / RealVNC / TightVNC"
        echo "---------------------------------------------"        
        echo "âœ… Screen Sharing (VNC) enabled."

    - name: ğŸŒ Show Connection Info
      run: |
        echo "---------------------------------------------"
        echo "ğŸ–¥ï¸  Connect to your macOS VM via Remote Desktop"
        echo "---------------------------------------------"
        echo "ğŸ’» Get the Tailscale IP from your Tailscale app"
        echo "ğŸ”‘ Password: (your VNC_PASS secret)"
        echo "ğŸ‘¤ User: runner"
        echo "---------------------------------------------"
        echo "ğŸ’¡ Tip: Use Microsoft Remote Desktop or any VNC client."
        echo "ğŸ’¡ Your machine should appear as 'GitHub-MacOS' in Tailscale!"

    - name: ğŸ§‘â€ğŸ’» Optional Debug Session (tmate)
      uses: mxschmitt/action-tmate@v3
      if: always()
