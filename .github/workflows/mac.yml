name: mac
on: 
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360
    steps:
    - uses: actions/checkout@v3

    - name: ğŸ§° Setup Environment
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        RDP_USER: runner
        RDP_PASS: ${{ secrets.RDP_PASS }}
      run: |
        brew install --quiet ngrok jq xrdp
        echo "$RDP_PASS" | sudo dscl . -passwd /Users/$RDP_USER
        sudo systemsetup -setremotelogin on
        sudo launchctl load -w /Library/LaunchDaemons/xrdp.plist || true
        ngrok authtoken "$NGROK_AUTH_TOKEN"
        ngrok tcp 3389 --region=us > ngrok.log &
        sleep 5
        echo "âœ… RDP Server is starting..."

    - name: ğŸŒ Show RDP Connection Info
      run: |
        sleep 10
        echo "---------------------------------------------"
        echo "ğŸ” Fetching ngrok TCP tunnel info..."
        NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "---------------------------------------------"
        echo "ğŸ–¥ï¸  Connect using Microsoft Remote Desktop:"
        echo "ğŸ‘‰ Address: ${NGROK_URL#tcp://}"
        echo "ğŸ‘¤ Username: runner"
        echo "ğŸ”‘ Password: (your RDP_PASS secret)"
        echo "---------------------------------------------"

    - name: ğŸ§‘â€ğŸ’» Optional Debug Session (tmate)
      uses: mxschmitt/action-tmate@v3
      if: always()
